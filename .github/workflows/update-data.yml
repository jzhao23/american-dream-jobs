name: Update Career Data

on:
  schedule:
    # Run on the 1st of every month at 6 AM UTC
    - cron: '0 6 1 * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create data directories
        run: |
          mkdir -p data/processed
          mkdir -p data/onet

      - name: Download O*NET Database
        run: |
          echo "Downloading O*NET database..."
          curl -L -o data/onet/onet_db.zip "https://www.onetcenter.org/dl_files/database/db_29_1_text.zip"
          cd data/onet && unzip -o onet_db.zip
          echo "O*NET database downloaded successfully"

      - name: Process O*NET Data
        run: npx tsx scripts/process-onet.ts

      - name: Fetch BLS Wages
        run: npx tsx scripts/fetch-bls-wages.ts

      - name: Score AI Risk
        run: npx tsx scripts/score-ai-risk.ts

      - name: Score National Importance
        run: npx tsx scripts/score-importance.ts

      - name: Create Career Progression Mappings
        run: npx tsx scripts/create-progression-mappings.ts

      - name: Generate Final Data
        run: npx tsx scripts/generate-final.ts

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet data/careers-index.json data/careers.generated.json || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: update career data'
          title: 'Monthly Career Data Update'
          body: |
            ## Automated Data Update

            This PR contains updated career data from the latest O*NET database and BLS statistics.

            ### Changes include:
            - Updated occupation information from O*NET 29.1
            - Refreshed wage data estimates
            - Re-scored AI automation risk
            - Re-scored national importance
            - Updated career progression mappings

            ### Files Updated:
            - `data/careers-index.json` - Career index for explorer
            - `data/careers.generated.json` - Full career data
            - `data/processed/*` - Intermediate processed files

            ---
            This PR was automatically generated by the data update workflow.
          branch: automated-data-update
          delete-branch: true
          labels: |
            automated
            data-update

      - name: Build site to verify data
        run: npm run build

      - name: Summary
        run: |
          echo "## Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Occupation Count" >> $GITHUB_STEP_SUMMARY
          echo "$(cat data/careers-index.json | jq 'length') careers in index" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Files" >> $GITHUB_STEP_SUMMARY
          echo "- careers-index.json: $(wc -c < data/careers-index.json | xargs) bytes" >> $GITHUB_STEP_SUMMARY
          echo "- careers.generated.json: $(wc -c < data/careers.generated.json | xargs) bytes" >> $GITHUB_STEP_SUMMARY
